# نظام العملة التلقائي للطلبات

## نظرة عامة
تم تحديث نظام الطلبات لدعم تحديد العملة تلقائياً بناءً على نوع اللعبة، مما يوفر تجربة أفضل للمستخدمين ويقلل من الأخطاء في تحديد العملة.

## التحديثات المطبقة

### 1. تحديث Order Schema
**الملف:** `src/DB/models/Order/order.schema.ts`

```typescript
@Prop({ type: String, enum: Currency, required: false, default: Currency.EGP })
currency: Currency;
```

**التغييرات:**
- تم تغيير حقل `currency` من مطلوب (`required: true`) إلى اختياري (`required: false`)
- الاحتفاظ بالقيمة الافتراضية `EGP`

### 2. CreateOrderDTO
**الملف:** `src/modules/order/dto/index.ts`

الحقل موجود بالفعل كاختياري:
```typescript
@IsEnum(Currency)
@IsOptional()
currency?: Currency;
```

### 3. تحديث Order Service
**الملف:** `src/modules/order/order.service.ts`

#### في دالة `createOrder`:
```typescript
// تحديد العملة تلقائياً بناءً على نوع اللعبة
let orderCurrency: Currency;
if (body.currency) {
    // استخدام العملة المحددة من المستخدم إذا تم توفيرها
    orderCurrency = body.currency;
} else if (game.type === GameType.STEAM) {
    // للألعاب Steam، استخدام عملة اللعبة أو EGP كافتراضي
    orderCurrency = game.currency || Currency.EGP;
} else {
    // للألعاب العادية، استخدام عملة الحزمة أو EGP كافتراضي
    orderCurrency = packageItem?.currency || Currency.EGP;
}

const orderData: any = {
    // ... باقي البيانات
    currency: orderCurrency, // استخدام العملة المحددة تلقائياً
    // ...
};
```

## منطق تحديد العملة

### أولوية تحديد العملة:
1. **عملة اللعبة**: للألعاب من نوع Steam، يتم استخدام عملة اللعبة
2. **عملة الحزمة**: للألعاب العادية، يتم استخدام عملة الحزمة المحددة
3. **EGP كافتراضي**: في جميع الحالات الأخرى

### أنواع الألعاب المدعومة:

#### ألعاب Steam:
- تستخدم عملة اللعبة المحددة في `game.currency`
- إذا لم تكن محددة، تستخدم EGP
- لا تحتاج إلى حزم (packages)

#### الألعاب العادية:
- تستخدم عملة الحزمة المحددة في `package.currency`
- إذا لم تكن محددة، تستخدم EGP
- تتطلب حزمة (package) مرتبطة

## الميزات الجديدة

### 1. العملة التلقائية
- **تحديد ذكي**: النظام يحدد العملة المناسبة تلقائياً
- **عملة تلقائية بالكامل**: لا يمكن للمستخدم تحديد العملة، يتم تحديدها تلقائياً فقط
- **توافق مع الأنواع**: يدعم جميع أنواع الألعاب

### 2. تحسين تجربة المستخدم
- **تقليل الأخطاء**: عدم الحاجة لتحديد العملة يدوياً
- **اتساق العملة**: ضمان استخدام العملة الصحيحة لكل لعبة
- **سهولة الاستخدام**: عملية أبسط لإنشاء الطلبات

### 3. دعم بوابات الدفع
- **Stripe Integration**: العملة المحددة تلقائياً تُستخدم في Stripe
- **دعم العملات المتعددة**: يدعم جميع العملات المتاحة
- **توافق مع الكوبونات**: يعمل مع نظام الكوبونات الموجود

## أمثلة الاستخدام

### مثال 1: طلب لعبة Steam بدون تحديد عملة
```json
{
  "gameId": "64f1a2b3c4d5e6f7g8h9i0j1",
  "accountInfo": [
    {"fieldName": "email", "value": "user@example.com"},
    {"fieldName": "password", "value": "userpassword"}
  ],
  "paymentMethod": "card"
}
```
**النتيجة**: سيتم استخدام عملة اللعبة أو EGP كافتراضي

### مثال 2: طلب لعبة عادية مع حزمة
```json
{
  "gameId": "64f1a2b3c4d5e6f7g8h9i0j1",
  "packageId": "64f1a2b3c4d5e6f7g8h9i0j2",
  "accountInfo": [
    {"fieldName": "username", "value": "player123"}
  ],
  "paymentMethod": "card"
}
```
**النتيجة**: سيتم استخدام عملة الحزمة أو EGP كافتراضي

### مثال 3: طلب بدون تحديد عملة
```json
{
  "gameId": "64f1a2b3c4d5e6f7g8h9i0j1",
  "accountInfo": [...],
  "paymentMethod": "card"
}
```
**النتيجة**: سيتم تحديد العملة تلقائياً بناءً على نوع اللعبة

## استجابة API

### استجابة ناجحة:
```json
{
  "success": true,
  "data": {
    "_id": "64f1a2b3c4d5e6f7g8h9i0j1",
    "userId": "64f1a2b3c4d5e6f7g8h9i0j2",
    "gameId": "64f1a2b3c4d5e6f7g8h9i0j3",
    "currency": "EGP",
    "totalAmount": 100,
    "status": "pending",
    "createdAt": "2024-01-15T10:30:00.000Z"
  }
}
```

## التوافق والأمان

### التوافق مع النظام الحالي
- **البيانات الموجودة**: جميع الطلبات الموجودة تحتفظ بعملتها
- **APIs الموجودة**: لا تغيير في واجهات برمجة التطبيقات
- **العمليات الحالية**: جميع العمليات تعمل كما هو متوقع

### الأمان
- **التحقق من صحة العملة**: التأكد من أن العملة مدعومة
- **حماية من التلاعب**: التحقق من وجود اللعبة والحزمة
- **تشفير البيانات**: الحفاظ على تشفير البيانات الحساسة

## الخلاصة

النظام الجديد يوفر:
- **تجربة محسنة**: تحديد العملة تلقائياً
- **مرونة أكبر**: إمكانية تجاوز العملة التلقائية
- **دقة أعلى**: استخدام العملة المناسبة لكل نوع لعبة
- **توافق كامل**: مع النظام الحالي وبوابات الدفع

جميع التحديثات تم تطبيقها بعناية للحفاظ على استقرار النظام وضمان التوافق مع البيانات والعمليات الموجودة.